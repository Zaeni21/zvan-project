<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Zvan Demo Client</title>
</head>
<body>
  <h3>Zvan Demo â€” Sign & Submit</h3>
  <textarea id="patient" cols="80" rows="10">
{"name":"Alice Example","email":"alice@example.com","phone":"+62-812-0000","zip_code":"02134-5678","birth_year":1920,"reported_age":null,"notes":"clinic A"}
  </textarea><br/>
  <button id="sign">Sign & Submit</button>

  <pre id="out"></pre>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.esm.min.js";

    const out = (s)=> document.getElementById('out').textContent += s + "\n";

    document.getElementById('sign').onclick = async () => {
      try {
        if (!window.ethereum) { alert('Install MetaMask'); return; }
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        const address = await signer.getAddress();

        const nonce = Math.floor(Date.now()/1000) + "-" + Math.random().toString(36).slice(2,8);
        const message = `Authorize zvan at ${nonce}`;

        const signature = await signer.signMessage(message);

        const patientData = JSON.parse(document.getElementById('patient').value);

        const resp = await fetch('http://localhost:3000/submit', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ address, signature, message, patientData, nonce })
        });
        const data = await resp.json();
        out("Response: " + JSON.stringify(data, null, 2));
      } catch (e) {
        out("Error: " + e.message);
      }
    }
  </script>
</body>
</html>
